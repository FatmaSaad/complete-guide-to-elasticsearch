1
00:00:02,230 --> 00:00:08,140
サブアグリゲーションがどのようなものか分かったところで､ もう一つのポケットアグリゲーションを紹介しましょう｡ 

2
00:00:08,560 --> 00:00:15,040
ご存知のように､ 集約が使用する文書は､ 集約が定義されるコンテキストに依存します｡

3
00:00:15,100 --> 00:00:19,480
しかし､ 時には､ 与えられた集約のためのドキュメントをフィルタリングしたい場合があります｡ 

4
00:00:19,570 --> 00:00:27,580
例えば､ いくつかの商品があって､ 電子書籍と紙の書籍の両方が含まれるコンテキスト内でアグリゲーションを追加する必要があるのかもしれません｡

5
00:00:27,580 --> 00:00:30,460
でも､ 本当は紙の本にしか興味がないんですよね｡ 

6
00:00:30,850 --> 00:00:36,790
そして､ 集計がコンテキストとして使用する文書群を､ フィルターを使って絞り込むことができる｡ 

7
00:00:37,150 --> 00:00:41,260
フィルタは､ 検索クエリで行ったのと全く同じように､ クエリ句を使用します｡ 

8
00:00:41,260 --> 00:00:43,900
つまり､ これはタームクエリまたはマッチクエリである可能性があります｡ 

9
00:00:43,900 --> 00:00:49,870
例えば､ 集計を実行する前に文書をフィルタリングする例を見てみよう｡ 

10
00:00:50,380 --> 00:00:52,570
そこで､ 集計を追加してみましょう｡ 

11
00:00:52,840 --> 00:01:00,280
アンダースコアの合計金額フィールドの値が低い注文をフィルタリングしたいので､ low, underscore valueという名前にします｡

12
00:01:00,460 --> 00:01:04,510
そこで､ ここにレンジクエリでフィルタキーを追加してみます｡ 

13
00:01:04,510 --> 00:01:08,020
つまり､ このフィルターキーの中に通常のクエリ句を追加するだけです｡ 

14
00:01:08,020 --> 00:01:13,330
検索クエリの場合と同様､ アンダースコアの合計がフィールドになります｡ 

15
00:01:14,490 --> 00:01:18,960
そして､ ここではLCキーを50という値で使ってみます｡ 

16
00:01:19,620 --> 00:01:23,490
そして､ この低価値の集計にサブの集計を追加していくのです｡ 

17
00:01:23,490 --> 00:01:36,810
そこで､ このXキーを使って､ 集計の名前を平均金額とし､ フィールドのタイプを合計金額とすることにしましょう｡

18
00:01:37,350 --> 00:01:42,870
これ以上説明する前に､ とりあえず実行してみて､ 結果がどのようなものか見てみましょう｡

19
00:01:43,320 --> 00:01:43,650
おっとっと｡ 

20
00:01:43,650 --> 00:01:51,160
どうやらここのキーはスペルを間違えたようなので､ tではなくLCでなければならなかったようです｡ 

21
00:01:51,180 --> 00:01:52,380
もう一度実行してみましょう｡ 

22
00:01:53,100 --> 00:02:02,640
つまり､ AVG集計はフィルタのコンテキスト内で実行され､ 範囲指定クエリにマッチするドキュメントのみを集計するということである｡

23
00:02:02,880 --> 00:02:08,490
つまり､ レンジクエリはトップレベルのアグリゲーションであり､ クエリのコンテキストで実行されることを意味し､

24
00:02:08,490 --> 00:02:11,250
この場合は暗黙のマッチオールクエリである｡

25
00:02:11,340 --> 00:02:18,210
そして､ AVG集計はフィルター集計の文脈で実行され､ 一部の文書がフィルターで除外されていることを意味する｡

26
00:02:18,420 --> 00:02:24,510
つまり､ AVG集計の対象となるバケットには､ 値が50未満の注文は存在しないのです｡

27
00:02:25,370 --> 00:02:30,890
そして､ 別のアグリゲーション用のバケットを作る前に､ フィルターを使ってドキュメントをフィルタリングする方法です｡ 
