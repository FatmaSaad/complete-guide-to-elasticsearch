# Scripted updates

## Reducing the current value of `in_stock` by one

In the previous lecture, we reduced the "in_stock" field by one, which we did by explicitly specifying its new value.

Wouldn't it be cool if we could subtract the value by one, without needing to know the current value for the document?

That is, if we could do everything in one go, instead of having to retrieve the document first, subtract the field value by one, and then update the document.

We can do exactly this with so-called "scripted updates." Elasticsearch supports scripting, which enables you to write custom logic while accessing a document's values.

In this example, we can easily increase or decrease the "in_stock" field's value.

That's probably the simplest possible example, so that's the one I will go with, because scripting is a relatively big topic that we will cover later in the course.

I do want to mention, however, that you can also embed "if" statements and such, so you can think of scripting as a way to write custom code that looks similar to many programming languages.

To use a script, we will actually use the Update API as we did in the previous lecture, but just specify a "script" object within the request body.

```
POST /products/_update/100
{
  "script": {
    "source": "ctx._source.in_stock--"
  }
}
```

## Assigning an arbitrary value to `in_stock`

```
POST /products/_update/100
{
  "script": {
    "source": "ctx._source.in_stock = 10"
  }
}
```

## Using parameters within scripts

```
POST /products/_update/100
{
  "script": {
    "source": "ctx._source.in_stock -= params.quantity",
    "params": {
      "quantity": 4
    }
  }
}
```

## Conditionally setting the operation to `noop`

```
POST /products/_update/100
{
  "script": {
    "source": """
      if (ctx._source.in_stock == 0) {
        ctx.op = 'noop';
      }
      
      ctx._source.in_stock--;
    """
  }
}
```

## Conditionally update a field value

```
POST /products/_update/100
{
  "script": {
    "source": """
      if (ctx._source.in_stock > 0) {
        ctx._source.in_stock--;
      }
    """
  }
}
```

## Conditionally delete a document

```
POST /products/_update/100
{
  "script": {
    "source": """
      if (ctx._source.in_stock < 0) {
        ctx.op = 'delete';
      }
      
      ctx._source.in_stock--;
    """
  }
}
```